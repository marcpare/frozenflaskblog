title: Panoramas, Python, Pigeons
published: !!timestamp '2014-07-05 11:00:00'
active_page: blog
tags:
    - python
    - programming

What I thought would be a few minutes of poking on OpenCV to stitch some images together turned out to be a week-long dive into computer vision, linear algebra, geometry, eventually surfacing to meet our friend, the pigeon.

First, let's do a basic implementation of panorama stitching in Python. There's a great page by Dr. Christian Richardt on [practical exercises on Open CV](http://richardt.name/teaching/supervisions/vision-2011/practical/):

I did each of the exercises in item 3, "Panorama stitching". You can find [the full repo on Github](https://github.com/marcpare/stitch). The repo includes a Vagrantfile and a shell script so that you can get OpenCV installed running without much yak shaving.

If you just want to solve the stitching problem, you can actually ignore the tricky part of this, item (3). However, if you happen to want to stitch more than two images together, you need to have a robust offset and dimensions calculation.

This has some fiddly details, and it takes a bit of linear algebra. The code is probably the clearest way to walk through this if you want to know the details. 

One tricky bit is that when you apply the transformation that lines up one image with the other, you end up with a combined image that is larger. To get the images placed properly on the bigger image, you need to offset them. 

[offset scan]

The offset has to be combined with the transformation (homography) matrix. I did this with a matrix multiplication. For a translation (OX, OY), the transformation matrix is...

[scan]

We combine it with the homography matrix via matrix multiplication:  

  homography = translation * homography

Nice!

***

Eventually, I get a panorama of the view outside my office stitched together:

Then I stitch another:

[3 pic panorama]

And a fourth!

[4 pic]

Now I'm getting confident. Let's try to make a panorama of my bookcase. I'm going to do something different this time. I'm going to walk right to left, snapping pictures as I go. I've done all this fancy linear algebra which will _surely_ take care of everything automatically

[buggy pic]

Uh oh.

It turns out there's a difference between a "panorama" and a "mosaic".

It's a panorama if you stand in one place and only rotate the camera.

It's a mosaic if you translate the camera.

This is important because you can stitch panorama photos fairly easily using the homography matrix. That's what we did above.

Unfortunately, for mosaics, this doesn't work. There isn't an affine transform that can relate two pictures in a mosaic.

The argument is as follows: as I move from left to right, I gradually see the backs and fronts of books that are farther away from me (this is parallax in action). How could you transform the image to get rid of these? The only possible way would be with some knowledge of the 3D geometry of the subject, which we can't derive from just two pictures.

Fascinating, right? There's something very different about moving around (translation) versus spinning around (rotation).

Consequently, it seems, there isn't a nice way to automate stitching mosaics together. In the posts by other professionals that do this, I found the advice: take a bunch of pictures. Here's a tutorial from an archeologist along these linesâ€“
http://dinosaurpalaeo.wordpress.com/2013/01/20/using-hugin-part-4-mosaic-images/

But what if I don't necessarily want to stitch the images together? Here's a variation I came up with to visualize my book case.

* Use feature detection to find alignment points in the images. 
* Calculate a scale+translation matrix to align them. [2] 
* As you hover over the images, reveal the image nearest your cursor.

[embed a shot of the the viz here]
Click to enlarge and play around with it.

**have the images breathe before hovering!!! ***

The big takeaway from this exploration is that there are many knobs and dials in image stitching algorithms. You can really shape and tune the algorithms to fit your application; it's not one-size-fits-all.

Oh! One more fun fact. Turns out pigeons use the parallax effect that stymies image mosaics to their advantage: they bob their heads to get two different images at slightly different perspectives, allowing them to calculate depth (they can't do it like humans because their eyes are on the sides of their heads).

http://www.loc.gov/rr/scitech/mysteries/pigeon.html
(such a cool picture of pigeons with cameras)

OH! Got to include the shots of inadvertently good bugs.



[2] This is a fun bug and derivation. Allowing rotation worked really poorly (..rotated book image...). Can I get rid of the rotation calculation? I want to drop column 3...

I want the resulting equation to look like this:

Ax + By = C (...)

Not too hard to see that the following matrix calculates this for us:

Just feed it into a least squares estimator:




---


